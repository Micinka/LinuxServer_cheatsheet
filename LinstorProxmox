# ProxmoxVE instal drbd9 with LINSTOR HA Controller

# Install latest kernel headers and then drbd 9

echo "deb http://packages.linbit.com/proxmox/ proxmox-7 drbd-9" > /etc/apt/sources.list.d/linbit.list
wget -O- https://packages.linbit.com/package-signing-pubkey.asc | apt-key add -
apt update
apt install pve-headers -y
apt install drbd-dkms drbd-utils -y

# check if drbd module is loaded, just to be sure load it
rmmod drbd; modprobe drbd
grep -q drbd /etc/modules || echo "drbd" >> /etc/modules


apt-get -y install linstor-proxmox linstor-satellite
systemctl start linstor-satellite


# Prepare Linstor Controller for HA, install this on ALL nodes
# Temporarely enable controller service so we can create resources for HA controller

apt-get update && apt install -y linstor-controller linstor-client


# Disable the service on all nodes so it does not auto-start, this will be managed by drbd.reactor
systemctl disable linstor-controller.service
systemctl stop linstor-controller.service

# Chose one node from which we will start and configure the Linstor Cluster
systemctl start linstor-controller.service

#From here on we add nodes
linstor node create pve1 10.1.0.11
linstor node create pve2 10.1.0.12
linstor node create pve3 10.1.0.13

# Creatig storage pool on all 3 nodes, for example ZFS pool with created dataset for linstor  "fast/linstor"

# linstor storage-pool create "storage backend type" "node" "name of new pool" "stogage resource"
linstor storage-pool create zfs pve1 zfs_pool fast/linstor
# Repeat on all nodes to have same linstor storage pool on all nodes
linstor storage-pool create zfs pve2 zfs_pool fast/linstor
linstor storage-pool create zfs pve2 zfs_pool fast/linstor


# Refer to manual for more info on diferent storage backends https://linbit.com/drbd-user-guide/linstor-guide-1_0-en/#s-storage_pools


# Configure HA storage for linstor roaming controller

linstor resource-definition create linstor_db
linstor resource-definition drbd-options --on-no-quorum=io-error linstor_db
linstor resource-definition drbd-options --auto-promote=no linstor_db
linstor volume-definition create linstor_db 200M
linstor resource create linstor_db -s zfs_pool --auto-place 3
# In last command replace "zfs_pool" with your pool name which you created earlier

# Preparing for next step (mounting HA resource to folder with linstor database, more on that in a few rows)
drbdadm primary linstor_db

# Now disable the service (after creating nodes and the replicated resource for database)
systemctl stop --now linstor-controller

# Create service from which we will mount the HA resource containing the Linstor Database
# Repeat this step on every node
cat << EOF > /etc/systemd/system/var-lib-linstor.mount
[Unit]
Description=Filesystem for the LINSTOR controller

[Mount]
# you can use the minor like /dev/drbdX or the udev symlink
What=/dev/drbd/by-res/linstor_db/0
Where=/var/lib/linstor
EOF


# Rename folder containing current linstor database file, create new folder which we are gonna use as mount point for HA resource
mv /var/lib/linstor{,.orig}
mkdir /var/lib/linstor      # Repeat this step on every node
# we did this earlier, but just in case:       drbdadm primary linstor_db
mkfs.ext4 /dev/drbd/by-res/linstor_db/0
systemctl start var-lib-linstor.mount
cp -r /var/lib/linstor.orig/* /var/lib/linstor
systemctl start linstor-controller


# Repeat following steps on every node


# Now we want to install required package for drbd HA setup, and restart + enable the service
apt install drbd-reactor

# Create file with config for drbd-reactor
cat << EOF > //etc/drbd-reactor.d/linstor_db.toml
[[promoter]]
id = "linstor_db"
[promoter.resources.linstor_db]
start = ["var-lib-linstor.mount", "linstor-controller.service"]
EOF

systemctl restart drbd-reactor
systemctl enable drbd-reactor

# Check for errors in the service
systemctl status drbd-reactor

# Now we need to edit the linstor-satelite service to NOT delete the resource file for linstor controller DB at startup
systemctl edit linstor-satellite

# Add this to end of file
[Service]
Environment=LS_KEEP_RES=linstor_db

# And restart the service
systemctl restart linstor-satellite


# Now we need to tell linstor where avalible controllers could be, so we can use linstor commands on each node

cat << EOF > /etc/linstor/linstor-client.con
[global]
controllers=pve1,pve2,pve3
EOF


# We have HA LINSTOR controller and 3 node cluster with backend for replicating storage, now we need to create resource group for our VM images, etc.
# Refer to manual for more options in creatin resource groups and definitions, here we will create example resource group with placing resources on only 2 nodes

# We already have <zfs_pool> pool
linstor resource-group create images --storage-pool zfs_pool --place-count 2    # creating resource group with number of placements, more options in manual
linstor volume-group create images      # Creating volume group on top of resource-group, here our resources (VM drives, etc) get placed


# You can also exclude node from placing any resources to it, for example a tie-breaker node
#   linstor node set-property <node_name> AutoplaceTarget false

# And finaly you need to add the resource group to your /etc/pve/storage.cfg file to use the storage in GUI ( here the linstor-proxmox package does the job)
# Add this to your config file, change accorging node names and resource group names, etc.
drbd: linstor-images
<------>content images,rootdir
<------>controller pve1,pve2,pve3
<------>resourcegroup images
