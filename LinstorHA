# Continuing on our Linstor setup, we will create High Avability option on our 3 nodes

# Temporarely enable controller service so we can create resources for HA controller

apt-get update && apt install -y linstor-controller linstor-client


# Disable the service on all nodes so it does not auto-start, this will be managed by drbd.reactor
systemctl disable linstor-controller.service
systemctl stop linstor-controller.service

# Chose one node from which we will start and configure the Linstor Cluster
systemctl start linstor-controller.service


# Configure HA storage for linstor roaming controller
# You will need at least 2 nodes to create resource

linstor resource-definition create linstor_db
linstor resource-definition drbd-options --on-no-quorum=io-error linstor_db
linstor resource-definition drbd-options --auto-promote=no linstor_db
linstor volume-definition create linstor_db 200M
linstor resource create linstor_db -s zfs_pool --auto-place 3
# In last command replace "zfs_pool" with your pool name which you created earlier

# Preparing for next step (mounting HA resource to folder with linstor database, more on that in a few rows)
drbdadm primary linstor_db

# Now disable the service (after creating nodes and the replicated resource for database)
systemctl stop --now linstor-controller

# Create service from which we will mount the HA resource containing the Linstor Database
# Repeat this step on every node
cat << EOF > /etc/systemd/system/var-lib-linstor.mount
[Unit]
Description=Filesystem for the LINSTOR controller

[Mount]
# you can use the minor like /dev/drbdX or the udev symlink
What=/dev/drbd/by-res/linstor_db/0
Where=/var/lib/linstor
EOF


# Rename folder containing current linstor database file, create new folder which we are gonna use as mount point for HA resource
mv /var/lib/linstor{,.orig}
mkdir /var/lib/linstor      # Repeat this step on every node
# we did this earlier, but just in case:       drbdadm primary linstor_db
mkfs.ext4 /dev/drbd/by-res/linstor_db/0
systemctl start var-lib-linstor.mount
cp -r /var/lib/linstor.orig/* /var/lib/linstor
systemctl start linstor-controller


# Repeat following steps on every node


# Now we want to install required package for drbd HA setup, and restart + enable the service
apt install drbd-reactor

# Create file with config for drbd-reactor
cat << EOF > //etc/drbd-reactor.d/linstor_db.toml
[[promoter]]
id = "linstor_db"
[promoter.resources.linstor_db]
start = ["var-lib-linstor.mount", "linstor-controller.service"]
EOF

systemctl restart drbd-reactor
systemctl enable drbd-reactor

# Check for errors in the service
systemctl status drbd-reactor

# Now we need to edit the linstor-satelite service to NOT delete the resource file for linstor controller DB at startup
systemctl edit linstor-satellite

# Add this to end of file
[Service]
Environment=LS_KEEP_RES=linstor_db

# And restart the service
systemctl restart linstor-satellite


# Now we need to tell linstor where avalible controllers could be, so we can use linstor commands on each node
mkdir /etc/linstor
cat << EOF > /etc/linstor/linstor-client.conf
[global]
controllers=pve1,pve2,pve3
EOF

